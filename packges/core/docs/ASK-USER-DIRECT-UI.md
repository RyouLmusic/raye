# ask_user å·¥å…·ç›´æ¥ UI äº¤äº’æ–¹æ¡ˆ

## é—®é¢˜

åŸæœ‰çš„ `ask_user` å·¥å…·æµç¨‹ï¼š
1. LLM è°ƒç”¨ `ask_user` å·¥å…·
2. å·¥å…·è¿”å› `waiting_for_user` çŠ¶æ€
3. Loop çš„ `makeDecision` æ£€æµ‹åˆ°å¹¶åœæ­¢
4. ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥æ–°æ¶ˆæ¯ï¼Œé‡æ–°å¯åŠ¨ loop

è¿™ç§æ–¹å¼éœ€è¦ç”¨æˆ·ä¸»åŠ¨è¾“å…¥ï¼Œæ— æ³•å®ç°"å¼¹çª—å¼"çš„å®æ—¶äº¤äº’ã€‚

## è§£å†³æ–¹æ¡ˆ

é€šè¿‡**å…¨å±€å›è°ƒ + Promise**æœºåˆ¶ï¼Œè®© `ask_user` å·¥å…·èƒ½å¤ŸçœŸæ­£"ç­‰å¾…"ç”¨æˆ·è¾“å…¥ï¼š

### 1. æ ¸å¿ƒæœºåˆ¶ï¼ˆ`packges/core/src/tools/control.ts`ï¼‰

```typescript
// å…¨å±€å›è°ƒï¼šUI å±‚è®¾ç½®æ­¤å‡½æ•°
let globalAskUserHandler: ((question: string) => Promise<string>) | null = null;

export function setAskUserHandler(handler: (question: string) => Promise<string>) {
    globalAskUserHandler = handler;
}

export const ask_user = tool({
    // ...
    execute: async (args) => {
        if (globalAskUserHandler) {
            // ğŸ”¥ ç›´æ¥ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼ˆé˜»å¡å·¥å…·æ‰§è¡Œï¼‰
            const userReply = await globalAskUserHandler(args.question);
            return {
                status: "answered",
                question: args.question,
                answer: userReply,
                message: `ç”¨æˆ·å›å¤: ${userReply}`,
            };
        }
        
        // é™çº§æ–¹æ¡ˆï¼šè¿”å›ç­‰å¾…çŠ¶æ€
        return {
            status: "waiting_for_user",
            question: args.question,
            message: `[ç­‰å¾…ç”¨æˆ·å›å¤] ${args.question}`,
        };
    }
});
```

### 2. UI Hook é›†æˆï¼ˆ`packges/ui/src/hooks/useAgentLoop.ts`ï¼‰

```typescript
export interface UseAgentLoopOptions {
    onAskUser?: (question: string) => Promise<string>;
}

export function useAgentLoop(
    agentConfig: AgentConfig, 
    sessionId: string,
    options?: UseAgentLoopOptions
) {
    // è®¾ç½®å…¨å±€å›è°ƒ
    useEffect(() => {
        if (options?.onAskUser) {
            setAskUserHandler(options.onAskUser);
        }
        return () => clearAskUserHandler();
    }, [options?.onAskUser]);
    
    // ... rest of the hook
}
```

### 3. ä½¿ç”¨ç¤ºä¾‹

```typescript
import { useAgentLoop } from "@/hooks/useAgentLoop";
import { useState } from "react";

function ChatInterface() {
    const [pendingQuestion, setPendingQuestion] = useState<{
        question: string;
        resolve: (answer: string) => void;
    } | null>(null);

    const { state, submit } = useAgentLoop(agentConfig, sessionId, {
        // ğŸ”¥ å½“ LLM è°ƒç”¨ ask_user æ—¶ï¼Œæ­¤å‡½æ•°è¢«è°ƒç”¨
        onAskUser: async (question: string) => {
            return new Promise<string>((resolve) => {
                // æ˜¾ç¤ºå¼¹çª—/è¾“å…¥æ¡†
                setPendingQuestion({ question, resolve });
            });
        }
    });

    const handleUserReply = (answer: string) => {
        if (pendingQuestion) {
            // ç”¨æˆ·è¾“å…¥åï¼Œresolve Promise
            pendingQuestion.resolve(answer);
            setPendingQuestion(null);
        }
    };

    return (
        <div>
            {/* èŠå¤©ç•Œé¢ */}
            <ChatMessages messages={state.messages} />
            
            {/* ask_user å¼¹çª— */}
            {pendingQuestion && (
                <Modal>
                    <p>{pendingQuestion.question}</p>
                    <input 
                        onSubmit={(e) => handleUserReply(e.target.value)} 
                    />
                </Modal>
            )}
        </div>
    );
}
```

## å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. LLM è°ƒç”¨ ask_user({ question: "æ‚¨æƒ³è¦ä»€ä¹ˆï¼Ÿ" })          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ask_user.execute() è°ƒç”¨ globalAskUserHandler(question)   â”‚
â”‚    â†’ è¿”å› Promise<string>ï¼ˆpending çŠ¶æ€ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. UI å±‚çš„ onAskUser è¢«è§¦å‘                                 â”‚
â”‚    â†’ setPendingQuestion({ question, resolve })              â”‚
â”‚    â†’ æ˜¾ç¤ºå¼¹çª—/è¾“å…¥æ¡†                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ (ç”¨æˆ·è¾“å…¥ä¸­...)
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç”¨æˆ·è¾“å…¥ç­”æ¡ˆå¹¶æäº¤                                       â”‚
â”‚    â†’ resolve(answer)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Promise å®Œæˆï¼Œask_user.execute() è¿”å›ç»“æœ               â”‚
â”‚    â†’ { status: "answered", answer: "..." }                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. LLM æ”¶åˆ°ç”¨æˆ·ç­”æ¡ˆï¼Œç»§ç»­æ‰§è¡Œåç»­ä»»åŠ¡                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®ä¼˜åŠ¿

1. **çœŸæ­£çš„é˜»å¡ç­‰å¾…**ï¼š`ask_user` å·¥å…·çš„ `execute` å‡½æ•°ä¼šç­‰å¾… Promise å®Œæˆï¼Œä¸ä¼šç«‹å³è¿”å›
2. **æ— éœ€ä¿®æ”¹ Loop é€»è¾‘**ï¼šLoop ä¸éœ€è¦æ£€æµ‹ `ask_user` å¹¶åœæ­¢ï¼Œå·¥å…·è‡ªå·±å¤„ç†ç­‰å¾…
3. **UI å®Œå…¨æ§åˆ¶äº¤äº’æ–¹å¼**ï¼šå¯ä»¥æ˜¯å¼¹çª—ã€ä¾§è¾¹æ ã€å†…è”è¾“å…¥æ¡†ç­‰ä»»ä½•å½¢å¼
4. **ä¿æŒæ¶ˆæ¯è¿è´¯æ€§**ï¼šç”¨æˆ·çš„å›å¤ç›´æ¥ä½œä¸ºå·¥å…·è¿”å›å€¼ï¼ŒLLM åœ¨åŒä¸€è½®å¯¹è¯ä¸­æ”¶åˆ°ç­”æ¡ˆ

## é™çº§æ–¹æ¡ˆ

å¦‚æœ UI å±‚æ²¡æœ‰è®¾ç½® `onAskUser` å›è°ƒï¼Œ`ask_user` å·¥å…·ä¼šè¿”å› `waiting_for_user` çŠ¶æ€ï¼ŒLoop çš„ `makeDecision` ä¼šæ£€æµ‹åˆ°å¹¶åœæ­¢ï¼Œå›é€€åˆ°åŸæœ‰çš„æ‰‹åŠ¨è¾“å…¥æµç¨‹ã€‚

## æ³¨æ„äº‹é¡¹

1. **å…¨å±€å•ä¾‹**ï¼š`globalAskUserHandler` æ˜¯å…¨å±€å˜é‡ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ª agent ä½¿ç”¨
2. **è¶…æ—¶å¤„ç†**ï¼šå»ºè®®åœ¨ `onAskUser` ä¸­æ·»åŠ è¶…æ—¶é€»è¾‘ï¼Œé¿å…æ— é™ç­‰å¾…
3. **é”™è¯¯å¤„ç†**ï¼šå¦‚æœç”¨æˆ·å–æ¶ˆè¾“å…¥ï¼Œåº”è¯¥ reject Promise æˆ–è¿”å›ç‰¹æ®Šå€¼

## ä¸ LLM çš„é…åˆ

åœ¨ Agent prompt ä¸­è¯´æ˜ `ask_user` çš„è¡Œä¸ºï¼š

```
## ask_user å·¥å…·

å½“ä½ éœ€è¦è¯¢é—®ç”¨æˆ·æ—¶ï¼Œè°ƒç”¨ `ask_user({ question: "ä½ çš„é—®é¢˜" })`ã€‚

ç³»ç»Ÿä¼šè‡ªåŠ¨å¼¹å‡ºè¾“å…¥æ¡†ï¼Œç­‰å¾…ç”¨æˆ·å›å¤åï¼Œä½ ä¼šæ”¶åˆ°ç­”æ¡ˆå¹¶ç»§ç»­æ‰§è¡Œã€‚

ç¤ºä¾‹ï¼š
- ä½ ï¼šask_user({ question: "æ‚¨æƒ³è¦ç”Ÿæˆ PDF è¿˜æ˜¯ Excel æŠ¥å‘Šï¼Ÿ" })
- ç³»ç»Ÿï¼š[ç­‰å¾…ç”¨æˆ·è¾“å…¥...]
- ç”¨æˆ·ï¼šPDF
- ä½ ï¼šå¥½çš„ï¼Œæˆ‘å°†ç”Ÿæˆ PDF æŠ¥å‘Š...
```

## å¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **åŸæ–¹æ¡ˆ**ï¼ˆLoop æ£€æµ‹å¹¶åœæ­¢ï¼‰ | ç®€å•ï¼Œæ— éœ€å…¨å±€çŠ¶æ€ | éœ€è¦ç”¨æˆ·ä¸»åŠ¨è¾“å…¥ï¼Œæ— æ³•å®ç°å¼¹çª—äº¤äº’ |
| **æ–°æ–¹æ¡ˆ**ï¼ˆå…¨å±€å›è°ƒ + Promiseï¼‰ | çœŸæ­£çš„å®æ—¶äº¤äº’ï¼ŒUI å®Œå…¨æ§åˆ¶ | éœ€è¦å…¨å±€å˜é‡ï¼Œç¨å¾®å¤æ‚ |

## æ€»ç»“

é€šè¿‡å…¨å±€å›è°ƒæœºåˆ¶ï¼Œ`ask_user` å·¥å…·å¯ä»¥ç›´æ¥ä¸ UI å±‚äº¤äº’ï¼Œå®ç°çœŸæ­£çš„"é˜»å¡å¼"ç”¨æˆ·è¾“å…¥ï¼Œæ— éœ€ç­‰å¾… Loop çš„ `makeDecision` æ£€æµ‹ã€‚è¿™ç§æ–¹å¼æ›´ç¬¦åˆç°ä»£ UI çš„äº¤äº’æ¨¡å¼ï¼ˆå¼¹çª—ã€å¯¹è¯æ¡†ç­‰ï¼‰ã€‚
