# é”™è¯¯å¤„ç†ä¸è‡ªåŠ¨é‡è¯•æœºåˆ¶

## é—®é¢˜æè¿°

åœ¨ä½¿ç”¨ä¸åŒçš„ LLM æä¾›å•†æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°å„ç§é”™è¯¯ï¼š

1. **ç±»å‹éªŒè¯é”™è¯¯** (`AI_TypeValidationError`)
   - æ¨¡å‹è¿”å›çš„å“åº”æ ¼å¼ä¸ç¬¦åˆ OpenAI æ ‡å‡†
   - ä¾‹å¦‚ï¼š`choices` å­—æ®µä¸º `null` è€Œä¸æ˜¯æ•°ç»„
   - å¸¸è§äºé OpenAI å…¼å®¹çš„æ¨¡å‹ï¼ˆå¦‚æŸäº› Qwen éƒ¨ç½²ï¼‰

2. **ç½‘ç»œé”™è¯¯**
   - è¿æ¥è¶…æ—¶ (`ETIMEDOUT`)
   - è¿æ¥è¢«æ‹’ç» (`ECONNREFUSED`)
   - DNS è§£æå¤±è´¥ (`ENOTFOUND`)

3. **æœåŠ¡ç«¯é”™è¯¯**
   - é€Ÿç‡é™åˆ¶ (429)
   - æœåŠ¡å™¨é”™è¯¯ (500, 502, 503, 504)

4. **è®¤è¯é”™è¯¯**
   - 401 Unauthorized
   - 403 Forbidden

## è§£å†³æ–¹æ¡ˆ

### 1. æ‰©å±•å¯é‡è¯•é”™è¯¯ç±»å‹

åœ¨ `packges/core/src/session/processor/executor.ts` çš„ `getRetryInfo` å‡½æ•°ä¸­ï¼Œæ·»åŠ å¯¹ `AI_TypeValidationError` çš„è¯†åˆ«ï¼š

```typescript
function getRetryInfo(error: unknown): RetryInfo {
    if (!error) {
        return { isRetryable: false };
    }

    const err = error as RetryableErrorShape;
    const status = err.status ?? err.statusCode;
    
    // æ£€æŸ¥ AI SDK ç±»å‹éªŒè¯é”™è¯¯ï¼ˆæ¨¡å‹è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼‰
    // è¿™ç±»é”™è¯¯é€šå¸¸æ˜¯ä¸´æ—¶çš„ï¼Œå¯ä»¥é‡è¯•
    if (err.name === "AI_TypeValidationError" || 
        err.message?.includes("Type validation failed") ||
        err.message?.includes("Invalid input")) {
        return { isRetryable: true };
    }
    
    // ... å…¶ä»–é”™è¯¯æ£€æŸ¥
}
```

### 2. å¢å¼ºé”™è¯¯æ—¥å¿—

åœ¨æ•è·é”™è¯¯æ—¶ï¼Œè®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œé‡è¯•è®¡åˆ’ï¼š

```typescript
} catch (error) {
    context.error = error as Error;
    const retryInfo = getRetryInfo(error);
    
    const logger = createLogger("Executor", input.debug ?? process.env.RAYE_DEBUG === "1");
    
    if (retryInfo.isRetryable && context.retryCount < context.maxRetries) {
        const err = error as any;
        const errorType = err.name || "Unknown";
        const errorMsg = err.message?.substring(0, 100) || "No message";
        
        logger.warn(`âš ï¸  LLM è°ƒç”¨å¤±è´¥ (${errorType}): ${errorMsg}`);
        logger.log(`ğŸ”„ å°†åœ¨ ${context.retryDelay}ms åé‡è¯• (${context.retryCount + 1}/${context.maxRetries})`);
        
        context.state = "RETRYING";
        // å¯¹äºç±»å‹éªŒè¯é”™è¯¯ï¼Œä½¿ç”¨è¾ƒçŸ­çš„å»¶è¿Ÿï¼ˆ1ç§’ï¼‰
        if (err.name === "AI_TypeValidationError") {
            context.retryDelay = 1000;
        }
    } else {
        logger.error(`âŒ LLM è°ƒç”¨å¤±è´¥ï¼Œæ— æ³•é‡è¯•æˆ–å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°`);
        context.state = "ERROR";
    }
}
```

### 3. ä¼˜åŒ–é‡è¯•å»¶è¿Ÿç­–ç•¥

ä¸åŒç±»å‹çš„é”™è¯¯ä½¿ç”¨ä¸åŒçš„é‡è¯•å»¶è¿Ÿï¼š

| é”™è¯¯ç±»å‹ | å»¶è¿Ÿæ—¶é—´ | åŸå›  |
|---------|---------|------|
| `AI_TypeValidationError` | 1 ç§’ | æ ¼å¼é”™è¯¯ï¼Œå¿«é€Ÿé‡è¯•å³å¯ |
| 429 é€Ÿç‡é™åˆ¶ | 5 ç§’èµ·æ­¥ | éœ€è¦ç­‰å¾…é…é¢æ¢å¤ |
| ç½‘ç»œé”™è¯¯ | 2 ç§’ï¼ˆæŒ‡æ•°é€€é¿ï¼‰ | ç­‰å¾…ç½‘ç»œæ¢å¤ |
| æœåŠ¡å™¨é”™è¯¯ | 2 ç§’ï¼ˆæŒ‡æ•°é€€é¿ï¼‰ | ç­‰å¾…æœåŠ¡æ¢å¤ |

## é‡è¯•æœºåˆ¶å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CALLING   â”‚ â† å‘èµ· LLM API è°ƒç”¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ æˆåŠŸ â”€â”€â†’ STREAMING
       â”‚
       â””â”€ å¤±è´¥ â”€â”€â†’ æ£€æŸ¥æ˜¯å¦å¯é‡è¯•
                   â”‚
                   â”œâ”€ å¯é‡è¯• + æœªè¾¾ä¸Šé™ â”€â”€â†’ RETRYING
                   â”‚                        â”‚
                   â”‚                        â”œâ”€ ç­‰å¾…å»¶è¿Ÿ
                   â”‚                        â”‚
                   â”‚                        â””â”€ é‡æ–°è¿›å…¥ CALLING
                   â”‚
                   â””â”€ ä¸å¯é‡è¯• / è¾¾ä¸Šé™ â”€â”€â†’ ERROR
```

## é…ç½®å‚æ•°

åœ¨ `agent.json` ä¸­é…ç½®é‡è¯•å‚æ•°ï¼š

```json
{
    "name": "agent",
    "max_retries": 5,  // æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 5ï¼‰
    "timeout": 640000  // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
}
```

åœ¨ `ExecuteInput` ä¸­å¯ä»¥è¦†ç›–ï¼š

```typescript
await Processor.execute({
    agent: agentConfig,
    messages: [...context.session.messages],
    maxRetries: 5,  // è¦†ç›– agent.json ä¸­çš„é…ç½®
    timeout: agentConfig.timeout,
});
```

## å¯é‡è¯•é”™è¯¯åˆ—è¡¨

### è‡ªåŠ¨é‡è¯•
- `AI_TypeValidationError` - AI SDK ç±»å‹éªŒè¯å¤±è´¥
- `ECONNREFUSED` - è¿æ¥è¢«æ‹’ç»
- `ETIMEDOUT` - è¿æ¥è¶…æ—¶
- `ENOTFOUND` - DNS è§£æå¤±è´¥
- HTTP 429 - é€Ÿç‡é™åˆ¶
- HTTP 500 - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
- HTTP 502 - ç½‘å…³é”™è¯¯
- HTTP 503 - æœåŠ¡ä¸å¯ç”¨
- HTTP 504 - ç½‘å…³è¶…æ—¶
- åŒ…å« "timeout" çš„é”™è¯¯æ¶ˆæ¯

### ä¸å¯é‡è¯•
- HTTP 401 - è®¤è¯å¤±è´¥ï¼ˆéœ€è¦ä¿®å¤ API å¯†é’¥ï¼‰
- HTTP 403 - æƒé™ä¸è¶³
- HTTP 400 - è¯·æ±‚é”™è¯¯ï¼ˆéœ€è¦ä¿®å¤è¯·æ±‚å‚æ•°ï¼‰
- HTTP 404 - èµ„æºä¸å­˜åœ¨
- å…¶ä»–ä¸šåŠ¡é€»è¾‘é”™è¯¯

## ç”¨æˆ·ä½“éªŒ

ä¿®å¤åï¼Œç”¨æˆ·ä¼šçœ‹åˆ°æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œé‡è¯•è¿›åº¦ï¼š

```
âš ï¸  LLM è°ƒç”¨å¤±è´¥ (AI_TypeValidationError): Type validation failed: Value: {"id":"chatcmpl-...
ğŸ”„ å°†åœ¨ 1000ms åé‡è¯• (1/5)
â³ é‡è¯• 1/5ï¼Œç­‰å¾… 1000ms...
```

å¦‚æœé‡è¯•æˆåŠŸï¼Œå¯¹è¯ä¼šè‡ªåŠ¨ç»§ç»­ï¼Œç”¨æˆ·æ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚

å¦‚æœè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¼šæ˜¾ç¤ºï¼š

```
âŒ LLM è°ƒç”¨å¤±è´¥ï¼Œæ— æ³•é‡è¯•æˆ–å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°
```

## æœ€ä½³å®è·µ

1. **é€‰æ‹©ç¨³å®šçš„æ¨¡å‹æä¾›å•†**
   - ä¼˜å…ˆä½¿ç”¨ OpenAI å…¼å®¹çš„ API
   - æµ‹è¯•æ¨¡å‹çš„å“åº”æ ¼å¼æ˜¯å¦æ ‡å‡†

2. **åˆç†é…ç½®é‡è¯•æ¬¡æ•°**
   - å¯¹äºä¸ç¨³å®šçš„ç½‘ç»œç¯å¢ƒï¼Œå¢åŠ  `max_retries`
   - å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®è®¾ç½®ä¸º 5-10 æ¬¡

3. **ç›‘æ§é”™è¯¯æ—¥å¿—**
   - å¯ç”¨ debug æ¨¡å¼æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   - è®°å½•é¢‘ç¹å‡ºç°çš„é”™è¯¯ç±»å‹
   - æ ¹æ®é”™è¯¯ç±»å‹è°ƒæ•´é…ç½®æˆ–æ›´æ¢æä¾›å•†

4. **å¤„ç†ä¸å¯é‡è¯•é”™è¯¯**
   - 401/403 é”™è¯¯ï¼šæ£€æŸ¥ API å¯†é’¥é…ç½®
   - 400 é”™è¯¯ï¼šæ£€æŸ¥è¯·æ±‚å‚æ•°å’Œæ¨¡å‹é…ç½®
   - 404 é”™è¯¯ï¼šæ£€æŸ¥æ¨¡å‹åç§°å’Œ base_url

## è°ƒè¯•æŠ€å·§

å¯ç”¨ debug æ¨¡å¼æŸ¥çœ‹å®Œæ•´çš„é”™è¯¯ä¿¡æ¯ï¼š

```typescript
await AgentLoop.loop({
    sessionId,
    agentConfig,
    message: userMsg,
    debug: true,  // å¯ç”¨ debug æ—¥å¿—
});
```

æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
export RAYE_DEBUG=1
```

è¿™ä¼šè¾“å‡ºè¯¦ç»†çš„ LLM è°ƒç”¨å‚æ•°ã€æ¶ˆæ¯å†å²å’Œé”™è¯¯å †æ ˆã€‚

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆ AI_TypeValidationError æ˜¯å¯é‡è¯•çš„ï¼Ÿ

A: è¿™ç±»é”™è¯¯é€šå¸¸æ˜¯ç”±äºæ¨¡å‹æä¾›å•†çš„ä¸´æ—¶é—®é¢˜å¯¼è‡´çš„å“åº”æ ¼å¼å¼‚å¸¸ã€‚é‡è¯•é€šå¸¸èƒ½è§£å†³é—®é¢˜ï¼Œå› ä¸ºä¸‹ä¸€æ¬¡è°ƒç”¨å¯èƒ½ä¼šè¿”å›æ­£ç¡®çš„æ ¼å¼ã€‚

### Q: é‡è¯•ä¼šæ¶ˆè€—é¢å¤–çš„ API é…é¢å—ï¼Ÿ

A: æ˜¯çš„ã€‚æ¯æ¬¡é‡è¯•éƒ½ä¼šå‘èµ·æ–°çš„ API è°ƒç”¨ã€‚å»ºè®®ç›‘æ§é‡è¯•é¢‘ç‡ï¼Œå¦‚æœæŸä¸ªæä¾›å•†é¢‘ç¹å‡ºé”™ï¼Œè€ƒè™‘æ›´æ¢ã€‚

### Q: å¦‚ä½•ç¦ç”¨è‡ªåŠ¨é‡è¯•ï¼Ÿ

A: è®¾ç½® `maxRetries: 0`ï¼š

```typescript
await Processor.execute({
    agent: agentConfig,
    messages: [...context.session.messages],
    maxRetries: 0,  // ç¦ç”¨é‡è¯•
});
```

### Q: é‡è¯•ä¼šå½±å“ç”¨æˆ·ä½“éªŒå—ï¼Ÿ

A: é‡è¯•æ˜¯é€æ˜çš„ï¼Œç”¨æˆ·åªä¼šçœ‹åˆ°ç¨å¾®å»¶è¿Ÿçš„å“åº”ã€‚å¯¹äºå¿«é€Ÿå¤±è´¥çš„é”™è¯¯ï¼ˆå¦‚ç±»å‹éªŒè¯ï¼‰ï¼Œå»¶è¿Ÿé€šå¸¸åœ¨ 1-2 ç§’å†…ã€‚
