# æ¨ç†æ˜¾ç¤ºä¸­æ–­é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

åœ¨ä½¿ç”¨ `processFullStream` å¤„ç†å¸¦æœ‰æ¨ç†ï¼ˆreasoningï¼‰å’Œå·¥å…·è°ƒç”¨çš„æµå¼å†…å®¹æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°æ¨ç†å†…å®¹æ˜¾ç¤ºè¢«ä¸­æ–­çš„é—®é¢˜ã€‚

### é—®é¢˜åœºæ™¯

```
ğŸ’­ [å¼€å§‹æ¨ç†]
ç”¨æˆ·è¦æ±‚æˆ‘è®¡ç®—ä¸¤ä¸ªæ•°å­¦é—®é¢˜ï¼š
1. 565åŠ 44
2. 244ä¹˜886

æˆ‘éœ€è¦ä½¿ç”¨calculateå‡½æ•°æ¥å®Œæˆè¿™ä¸¤ä¸ªè®¡ç®—ã€‚æˆ‘éœ€è¦åˆ†åˆ«è°ƒç”¨ä¸¤æ¬¡å‡½æ•°ã€‚

ç¬¬ä¸€ä¸ªè®¡ç®—ï¼š565 + 44ï¼Œoperationæ˜¯"add"
ç¬¬äºŒä¸ªè®¡ç®—ï¼š244 * 88
ğŸ”§ [è°ƒç”¨å·¥å…·: calculate]  <-- è¿™é‡Œæ¨ç†è¢«æ‰“æ–­äº†ï¼
   å‚æ•°: {"a":565,"b":44,"operation":"add"}
âœ… [å·¥å…·ç»“æœ]
...
```

æ¨ç†å†…å®¹åœ¨ "244 * 88" åé¢åº”è¯¥ç»§ç»­ï¼Œä½†å› ä¸ºå·¥å…·è°ƒç”¨äº‹ä»¶æ’å…¥ï¼Œå¯¼è‡´æ˜¾ç¤ºè¢«ä¸­æ–­ã€‚

## åŸå› åˆ†æ

### äº‹ä»¶æµé¡ºåº

åœ¨æµå¼å¤„ç†ä¸­ï¼ŒAI SDK è¿”å›çš„äº‹ä»¶é¡ºåºå¯èƒ½æ˜¯ï¼š

```
1. reasoning-start      â†’ æ‰“å° "ğŸ’­ [å¼€å§‹æ¨ç†]"
2. reasoning-delta      â†’ è¾“å‡º "ç”¨æˆ·è¦æ±‚æˆ‘..."ï¼ˆæ— æ¢è¡Œï¼‰
3. reasoning-delta      â†’ ç»§ç»­è¾“å‡º "è®¡ç®—..."
4. tool-call            â†’ æ‰“å° "\nğŸ”§ [è°ƒç”¨å·¥å…·...]"  âš ï¸ åœ¨è¿™é‡Œæ’å…¥
5. tool-result          â†’ æ‰“å°å·¥å…·ç»“æœ
6. reasoning-delta      â†’ ç»§ç»­è¾“å‡ºæ¨ç†å†…å®¹ï¼ˆä½†å·²ç»è¢«æ‰“æ–­ï¼‰
7. reasoning-end        â†’ æ‰“å° "ğŸ’­ [æ¨ç†å®Œæˆ]"
```

### æ ¸å¿ƒé—®é¢˜

1. **æµå¼è¾“å‡ºä¸æ¢è¡Œ**ï¼š`reasoning-delta` ä½¿ç”¨ `process.stdout.write()` è¿ç»­è¾“å‡ºï¼Œä¸è‡ªåŠ¨æ¢è¡Œ
2. **äº‹ä»¶çªç„¶æ’å…¥**ï¼šå·¥å…·è°ƒç”¨äº‹ä»¶åœ¨æ¨ç†è¿›è¡Œä¸­æ’å…¥ï¼Œç›´æ¥æ‰“å°åˆ°æ§åˆ¶å°
3. **æ ¼å¼è¢«ç ´å**ï¼šå·¥å…·è°ƒç”¨çš„æ¢è¡Œå’Œæ ¼å¼åŒ–æ‰“æ–­äº†æ¨ç†å†…å®¹çš„è¿è´¯æ€§

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ”¹è¿›çš„åŸºç¡€å¤„ç†å™¨ï¼ˆå·²ä¿®å¤ï¼‰

**ç‰¹ç‚¹**ï¼šæ·»åŠ çŠ¶æ€è·Ÿè¸ªï¼Œåœ¨å·¥å…·è°ƒç”¨å‰è‡ªåŠ¨æ¢è¡Œ

```typescript
import { processFullStream, createConsoleHandlers } from "core";

await processFullStream(result, {
    handlers: createConsoleHandlers({
        showReasoning: true,
        showTools: true
    })
});
```

**æ”¹è¿›å†…å®¹**ï¼š
- æ·»åŠ  `isReasoning` å’Œ `isTextOutput` çŠ¶æ€æ ‡è®°
- åœ¨å·¥å…·è°ƒç”¨å‰æ£€æŸ¥çŠ¶æ€ï¼Œå¦‚æœæ­£åœ¨è¾“å‡ºï¼Œå…ˆæ¢è¡Œ
- é¿å…å·¥å…·ä¿¡æ¯ç›´æ¥æ’å…¥åˆ°æ¨ç†å†…å®¹ä¸­é—´

**æ•ˆæœ**ï¼š
```
ğŸ’­ [å¼€å§‹æ¨ç†]
ç”¨æˆ·è¦æ±‚æˆ‘è®¡ç®—...
ç¬¬äºŒä¸ªè®¡ç®—ï¼š244 * 88
                        <-- è‡ªåŠ¨æ¢è¡Œ
ğŸ”§ [è°ƒç”¨å·¥å…·: calculate]
...
```

### æ–¹æ¡ˆ 2: åˆ†æ®µå¤„ç†å™¨ï¼ˆæ¨èï¼‰âœ¨

**ç‰¹ç‚¹**ï¼šä½¿ç”¨æ¸…æ™°çš„åˆ†éš”çº¿ï¼Œè®©å„éƒ¨åˆ†ç‹¬ç«‹æ˜¾ç¤º

```typescript
import { processFullStream, createSegmentedHandlers } from "core";

await processFullStream(result, {
    handlers: createSegmentedHandlers({
        showReasoning: true,
        showTools: true,
        bufferReasoning: false  // å®æ—¶æ˜¾ç¤º
    })
});
```

**æ•ˆæœ**ï¼š
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’­ æ¨ç†è¿‡ç¨‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç”¨æˆ·è¦æ±‚æˆ‘è®¡ç®—ä¸¤ä¸ªæ•°å­¦é—®é¢˜ï¼š
1. 565åŠ 44
2. 244ä¹˜886
æˆ‘éœ€è¦ä½¿ç”¨calculateå‡½æ•°...
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ å·¥å…·è°ƒç”¨: calculate
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å‚æ•°:
{
  "a": 565,
  "b": 44,
  "operation": "add"
}

ç»“æœ:
609
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

**ä¼˜ç‚¹**ï¼š
- è§†è§‰ä¸Šéå¸¸æ¸…æ™°
- å„éƒ¨åˆ†ç‹¬ç«‹ï¼Œä¸ä¼šæ··åœ¨ä¸€èµ·
- ä¿æŒå®æ—¶æµå¼è¾“å‡ºçš„ä½“éªŒ

### æ–¹æ¡ˆ 3: ç¼“å†²å¤„ç†å™¨

**ç‰¹ç‚¹**ï¼šå…ˆç¼“å†²æ¨ç†å†…å®¹ï¼Œå·¥å…·è°ƒç”¨åå†ç»Ÿä¸€æ˜¾ç¤º

```typescript
import { processFullStream, createSegmentedHandlers } from "core";

await processFullStream(result, {
    handlers: createSegmentedHandlers({
        showReasoning: true,
        showTools: true,
        bufferReasoning: true  // ç¼“å†²æ¨ç†
    })
});
```

**æ•ˆæœ**ï¼š
```
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ å·¥å…·è°ƒç”¨: calculate
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’­ æ¨ç†è¿‡ç¨‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[å®Œæ•´çš„æ¨ç†å†…å®¹ï¼Œä¸è¢«æ‰“æ–­]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**ä¼˜ç‚¹**ï¼š
- æ¨ç†å†…å®¹å®Œæ•´æ˜¾ç¤º
- é€‚åˆéœ€è¦æŸ¥çœ‹å®Œæ•´æ€è€ƒè¿‡ç¨‹çš„åœºæ™¯

**ç¼ºç‚¹**ï¼š
- å¤±å»å®æ—¶æµå¼ä½“éªŒ
- éœ€è¦ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆæ‰èƒ½çœ‹åˆ°æ¨ç†

## ä½¿ç”¨å»ºè®®

### åœºæ™¯ 1: ç»ˆç«¯åº”ç”¨ / CLI å·¥å…·

**æ¨è**ï¼š`createSegmentedHandlers()`

```typescript
await processFullStream(result, {
    handlers: createSegmentedHandlers()
});
```

### åœºæ™¯ 2: è°ƒè¯• / åˆ†ææ¨ç†è¿‡ç¨‹

**æ¨è**ï¼š`createSegmentedHandlers({ bufferReasoning: true })`

```typescript
await processFullStream(result, {
    handlers: createSegmentedHandlers({
        showReasoning: true,
        bufferReasoning: true
    })
});
```

### åœºæ™¯ 3: ç®€å•å¿«é€Ÿæµ‹è¯•

**æ¨è**ï¼š`createConsoleHandlers()`

```typescript
await processFullStream(result, {
    handlers: createConsoleHandlers()
});
```

### åœºæ™¯ 4: Web åº”ç”¨ / å®æ—¶æ¨é€

**æ¨è**ï¼šè‡ªå®šä¹‰å¤„ç†å™¨

```typescript
const handlers: StreamHandlers = {
    reasoning: {
        onDelta: (text) => {
            // å®æ—¶æ¨é€åˆ°å‰ç«¯
            ws.send(JSON.stringify({ 
                type: 'reasoning', 
                content: text 
            }));
        }
    },
    tool: {
        onCall: (id, name, args) => {
            // å‘é€å·¥å…·è°ƒç”¨äº‹ä»¶
            ws.send(JSON.stringify({ 
                type: 'tool-call', 
                tool: name, 
                args 
            }));
        }
    }
};
```

## æµ‹è¯•

è¿è¡Œæµ‹è¯•æ–‡ä»¶æŸ¥çœ‹æ•ˆæœå¯¹æ¯”ï¼š

```bash
cd packges/core/test
bun stream-handler-reasoning-fix.test.ts
```

## API å‚è€ƒ

### createConsoleHandlers

```typescript
function createConsoleHandlers(options?: {
    showReasoning?: boolean;
    showTools?: boolean;
    showSteps?: boolean;
    colors?: {
        reasoning?: string;
        text?: string;
        tool?: string;
        step?: string;
        error?: string;
    };
}): StreamHandlers
```

### createSegmentedHandlers

```typescript
function createSegmentedHandlers(options?: {
    showReasoning?: boolean;
    showTools?: boolean;
    bufferReasoning?: boolean;  // æ˜¯å¦ç¼“å†²æ¨ç†å†…å®¹
}): StreamHandlers
```

## æ€»ç»“

| å¤„ç†å™¨ | å®æ—¶æ€§ | æ¸…æ™°åº¦ | æ¨ç†å®Œæ•´ | æ¨èåœºæ™¯ |
|--------|--------|--------|----------|----------|
| `createConsoleHandlers` | â­â­â­ | â­â­ | â­â­ | å¿«é€Ÿæµ‹è¯• |
| `createSegmentedHandlers` | â­â­â­ | â­â­â­ | â­â­â­ | CLIåº”ç”¨ï¼ˆæ¨èï¼‰ |
| `createSegmentedHandlers({ bufferReasoning: true })` | â­ | â­â­â­ | â­â­â­ | è°ƒè¯•åˆ†æ |

**æ¨èä½¿ç”¨**ï¼š`createSegmentedHandlers()` - å…¼é¡¾å®æ—¶æ€§å’Œæ¸…æ™°åº¦ âœ¨
